package dataStorageLayer;
import java.sql.*;
import java.util.List;
import java.util.ArrayList;

import applicationLayer.Administrator;
import applicationLayer.Borrower;
import applicationLayer.BranchUser;
import applicationLayer.Keeper;
import applicationLayer.Librarian;
import applicationLayer.Privilege;
import applicationLayer.States;

public class BranchStorageInterface {
	private static BranchStorageInterface instance = null;
	private final static String database = "jdbc:sqlite:branchlib.db"; 
	private static Connection conn;
	
	/**
	 * Private Constructor
	 * @throws Exception
	 */
	private BranchStorageInterface() throws Exception {
		Class.forName("org.sqlite.JDBC");		
		conn = DriverManager.getConnection(database);
	}
	
	/**
	 * Get or create a branch Storage connection
	 * @return Singleton instance of the branch storage interface
	 * @throws Exception
	 */
	public static BranchStorageInterface getInstance() throws Exception {
		if (instance == null)
			instance = new BranchStorageInterface();
		return instance;
	}
	
	/**
	 * Return all books associated with a keeper
	 * @param userID
	 * @return a list of book id kept by the keeper
	 * @throws Exception
	 */
	public List<Integer> getBooksByKeeper(int userID) throws Exception {
	    
	    List<Integer> alb = new ArrayList<Integer>(); 
	    Statement stat = conn.createStatement();
	    ResultSet rs = stat.executeQuery("SELECT bookid FROM books WHERE keeperid=" + userID + ";");
	    rs.close();
	    while (rs.next()) {
	    	alb.add(rs.getInt("bookid"));
	    }
	    return alb;
	}
	
	public List<Integer> getBooksByBorrower(int UserID) throws Exception {
		List<Integer> alb = new ArrayList<Integer>();
	    Statement stat = conn.createStatement();
	    ResultSet rs = stat.executeQuery("SELECT bookid FROM borrowedbooks WHERE userid=" + UserID + ";");
	    rs.close();
	    while(rs.next()) {
	    	alb.add(rs.getInt("userid"));
	    }
	    return alb;
	}
	
	/**
	 * 
	 * @param bookID
	 * @return userid of keeper
	 * @throws Exception
	 */
	public int getBookKeeper(int bookID) throws Exception {
	    Statement stat = conn.createStatement();
	    ResultSet rs = stat.executeQuery("SELECT keeperid FROM books WHERE bookid=" + bookID + ";");
	    rs.next();
	    int kid = rs.getInt("keeperid");
	    rs.close();
	    return kid;
	}
	
	/**
	 * 
	 * @param bookID
	 * @param Keeper k
	 * @throws Exception
	 */
	public void setBookKeeper(int bookID, int keeperid) throws Exception {
		Statement stat = conn.createStatement();
		ResultSet rs = stat.executeQuery("UPDATE books SET keeperid=" + keeperid + " WHERE bookid=" + bookID + ";");
		rs.close();
	}
	
	/**
	 * 
	 * @param bookID
	 * @return
	 * @throws ClassNotFoundException
	 * @throws SQLException
	 */
	public int getBookBorrower(int bookID) throws Exception	{
	    Statement stat = conn.createStatement();
	    ResultSet rs = stat.executeQuery("SELECT userid FROM borrowedbooks WHERE bookid=" + bookID + ";");
	    rs.next();
	    int userid = rs.getInt("userid");
	    rs.close();
	    return userid;
	}
	
	/**
	 * 
	 * @param bookID
	 * @param b
	 * @throws Exception
	 */
	public void setBookBorrower(int bookID, int borrowerId) throws Exception {
		Statement stat = conn.createStatement();
		ResultSet rs = stat.executeQuery("UPDATE books SET keeperid=" + borrowerId + " WHERE bookid=" + bookID + ";");
		rs.close();
	}
	
	/**
	 * 
	 * @param userID
	 * @return
	 * @throws ClassNotFoundException
	 * @throws SQLException
	 */
	public Class<?> getUserPrivilege(int userID) throws Exception {
		Statement stat = conn.createStatement();
		ResultSet rs = stat.executeQuery("SELECT privilege FROM users WHERE id=" + userID + ";");
		rs.next();
		int p = rs.getInt("privilege");
		rs.close();
		
		switch (p)
		{
			case 0: return BranchUser.class;
			case 1: return Borrower.class;
			case 2: return Keeper.class;
			case 3: return Administrator.class;
			case 4: return Librarian.class;
			default: return BranchUser.class;
		}
	}
	
	/**
	 * 
	 * @param userId
	 * @param p
	 * @throws Exception
	 */
	public void setUserPrivilege(int userId, Privilege p) throws Exception {
		Statement stat = conn.createStatement();
		ResultSet rs = stat.executeQuery("UPDATE privilege SET privilege=" + privilege + "WHERE id=" + userId + ";");
		rs.close();
	}
	
	/**
	 * 
	 * @param bookID
	 * @return
	 * @throws SQLException
	 * @throws ClassNotFoundException
	 */
	public States getBookState(int bookID) throws Exception	{
		Statement stat = conn.createStatement();
		ResultSet rs = stat.executeQuery("SELECT state FROM books WHERE bookid=" + bookID + ";");
		
		rs.next();
		States s = States.getStateById(rs.getInt("state"));
		rs.close();
		return s;
	}
	
	public void setBookState(int BookID, States s) throws Exception {
		Statement stat = conn.createStatement();
		ResultSet rs = stat.executeQuery("UPDATE books SET state=" + s.getId() + ";");
		rs.close();
	}
	
	/**
	 * 
	 * @param s
	 * @return
	 * @throws SQLException
	 * @throws ClassNotFoundException
	 */
	public List<Integer> getBooksByState(States s) throws Exception	{
		   List<Integer> lbb = new ArrayList<Integer>();
		   Statement stat = conn.createStatement();
		   ResultSet rs = stat.executeQuery("SELECT bookID FROM books WHERE state=" + s + ";");
		   while(rs.next())
		   {
			   int bid = rs.getInt("bookID");
			   lbb.add(bid);	   
		   }
		   return lbb;
	}
	
	/**
	 * 
	 * @param privilege p
	 * @return
	 * @throws SQLException
	 * @throws ClassNotFoundException
	 */
	public List<Integer> getUsersByPrivilege(Class<?> p) throws Exception {
		int privilege = 0;
		if (p == BranchUser.class)
			privilege = 0;
		else if (p == Borrower.class)
			privilege = 1;
		else if (p == Keeper.class)
			privilege = 2;
		else if (p == Administrator.class)
			privilege = 3;
		else if (p == Librarian.class)
			privilege = 4;
		
		List<Integer> li = new ArrayList<Integer>();
	    Statement stat = conn.createStatement();
	    ResultSet rs = stat.executeQuery("SELECT id FROM users WHERE privilege=" + privilege + " ORDER BY id ASC;");
	    while (rs.next()) {
	    	li.add(rs.getInt("id"));
	    }
	    rs.close();
	    return li;
	}
}
