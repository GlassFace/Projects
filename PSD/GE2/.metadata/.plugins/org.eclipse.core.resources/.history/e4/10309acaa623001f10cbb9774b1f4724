package dataStorageLayer;

import applicationLayer.BranchUser;
import applicationLayer.BranchUserImpl;
import uk.ac.gla.dcs.psd3.ay2009.project.CentralLibClient;
import uk.ac.gla.dcs.psd3.ay2009.project.CentralLibClientSQLImpl;
import uk.ac.gla.dcs.psd3.ay2009.project.model.User;
import java.util.*;


public class UserStorageFacade {
	private static UserStorageFacade instance = null;
	private CentralLibClient libClient = null;
	
	// *ToDo* Change this to the config file
	private static String dbPropertiesFN = "config/test/db.properties";
	
	private UserStorageFacade() {
		libClient = new CentralLibClientSQLImpl(dbPropertiesFN);
	}
	
	public static UserStorageFacade getInstance() {
		if (instance == null)
			instance = new UserStorageFacade();
		
		return instance;
	}
	
	private BranchUser userToBranchUser(User u) throws Exception {
		BranchUser bu = new BranchUserImpl();
		bu.setFirstName(u.getForename());
		bu.setLastName(u.getSurname());
		bu.setId(u.getID());
		bu.setIsStaff(u.getIsStaff());
		
		BranchStorageInterface bsi = BranchStorageInterface.getInstance();
		Class<?> c = bsi.getUserPrivilege(u.getID());
		return (BranchUser)c.cast(bu);
	}
	
	public BranchUser getUserById(int id) throws Exception {
		User u = libClient.getUserByID(id);
		return userToBranchUser(u);
	}
	
	/*public Keeper getKeeperById(int id) throws Exception {
		User u = libClient.getUserByID(id);
		//u.get
		
		Keeper bu = new Keeper();
		bu.setFirstName(u.getForename());
		bu.setLastName(u.getSurname());
		bu.setId(u.getID());
		bu.setIsStaff(u.getIsStaff());
		BranchStorageInterface bsi = BranchStorageInterface.getInstance();
		Privilege p = bsi.getUserPrivilege(u.getID());
		if (p != Privilege.KEEPER || p!= Privilege.ADMINISTRATOR)
			throw new Exception("Not a Keeper");
		bu.setPrivilege(p);
		
		return bu;
	}*/
	
	public List<BranchUser> getUsersByName(String firstname, String lastname) throws Exception {
		List<User> ul = libClient.findUsers(String.format("Surname='%s' AND Forename='%s'", firstname, lastname));
		List<BranchUser> bul = new ArrayList<BranchUser>();
	
		for(User u : ul) {
			bul.add(userToBranchUser(u));
		}
		
		return bul;
	}
	
	public void setUserPrivilege(int id, Class<?> c) throws Exception {
		BranchStorageInterface bsi = BranchStorageInterface.getInstance();
		bsi.setUserPrivilege(id, c);
	}
	
	public BranchUser login(int id, String password) {
		libClient.getUserByID(ID)
	}
}
